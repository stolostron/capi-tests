name: Security - gosec

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2:30 AM UTC
    - cron: '30 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gosec:
    name: Go Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run gosec security scanner
      uses: securego/gosec@master
      with:
        args: '-fmt=json -out=gosec-results.json -stdout -verbose=text ./...'
      continue-on-error: true
      id: gosec-scan

    - name: Generate summary
      if: always()
      run: |
        echo "# gosec Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f gosec-results.json ]; then
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")
          if [ "$ISSUES" = "0" ]; then
            echo "## ‚úÖ No security issues found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Go source code passed all gosec security checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Security issues detected: $ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Rule | File | Line | Details |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | \(.file) | \(.line) | \(.details) |"' gosec-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "1. Review each security issue listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Apply recommended fixes from gosec documentation" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run the scan to verify fixes" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No results file generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload gosec results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gosec-results
        path: gosec-results.json
        retention-days: 30

    - name: Create GitHub issue on security findings
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="gosec Security Scan"
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "gosec" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")
        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")
          
          FINDINGS_DETAILS=""
          if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
            FINDINGS_DETAILS=$(jq -r '.Issues[] | "**\(.severity)** - \(.rule_id) - `\(.file):\(.line)`\n\(.details)\n"' gosec-results.json 2>/dev/null | head -50)
          else
            FINDINGS_DETAILS="See workflow logs for details"
          fi

          BODY="## üîÑ Security Issues Still Present\n"
          BODY="${BODY}**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n"
          BODY="${BODY}**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n"
          BODY="${BODY}**Branch**: ${{ github.ref_name }}\n"
          BODY="${BODY}**Commit**: ${{ github.sha }}\n"
          BODY="${BODY}**Issues Count**: $ISSUES\n"
          BODY="${BODY}### Latest Findings\n"
          BODY="${BODY}<details>\n"
          BODY="${BODY}<summary>Click to expand gosec findings</summary>\n"
          BODY="${BODY}$FINDINGS_DETAILS\n"
          BODY="${BODY}</details>\n"
          BODY="${BODY}**Action Required**: Security issues persist. Please review and fix."

          echo -e "$BODY" > comment_body.md
          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '[.Issues[] | select(.severity == "HIGH")] | length' gosec-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq -r '[.Issues[] | select(.severity == "MEDIUM")] | length' gosec-results.json 2>/dev/null || echo "0")
          LOW=$(jq -r '[.Issues[] | select(.severity == "LOW")] | length' gosec-results.json 2>/dev/null || echo "0")
          
          FINDINGS_DETAILS=""
          if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
            FINDINGS_DETAILS=$(jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | `\(.file)` | \(.line) | \(.details) |"' gosec-results.json 2>/dev/null)
          else
            FINDINGS_DETAILS="See workflow run logs for complete details"
          fi

          BODY="# üö® Security Alert: Code Security Issues Detected (gosec)\n"
          BODY="${BODY}## Overview\n"
          BODY="${BODY}The **gosec** source code security scanner has detected security issues in the Go codebase.\n"
          BODY="| Field | Value |\n"
          BODY="|-------|-------|\n"
          BODY="| **Scanner** | gosec (Go AST security analyzer) |\n"
          BODY="| **Status** | ‚ùå FAILED |\n"
          BODY="| **Total Issues** | $ISSUES |\n"
          BODY="| **üî¥ HIGH** | $HIGH |\n"
          BODY="| **üü° MEDIUM** | $MEDIUM |\n"
          BODY="| **üü¢ LOW** | $LOW |\n"
          BODY="| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |\n"
          BODY="| **Branch** | 
${{ github.ref_name }}
 |\n"
          BODY="| **Commit** | 
${{ github.sha }}
 |\n"
          BODY="| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |\n"
          BODY="## üìã Security Issues Found\n"
          BODY="<details open>\n"
          BODY="<summary><b>Detailed Findings (Click to collapse)</b></summary>\n"
          BODY="$(if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
            echo "| Severity | Rule | File | Line | Details |"
            echo "|----------|------|------|------|---------|"
            jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | `\(.file)` | \(.line) | \(.details) |"' gosec-results.json 2>/dev/null
          else
            echo "See workflow run logs for complete details"
          fi)"
          BODY="</details>\n"
          BODY="## üîß Remediation Steps\n"
          BODY="### 1Ô∏è‚É£ Review Each Finding\n"
          BODY="- Examine the security issues listed above\n"
          BODY="- Understand the security risk for each\n"
          BODY="- Check gosec documentation for the specific rule ID\n"
          BODY="### 2Ô∏è‚É£ Fix Security Issues\n"
          BODY="Common fixes:\n"
          BODY="- **G104**: Add proper error handling\n"
          BODY="- **G304**: Validate file paths or add `\#nosec` with justification\n"
          BODY="- **G401/G501**: Use stronger crypto algorithms\n"
          BODY="- **Others**: Follow gosec recommendations\n"
          BODY="### 3Ô∏è‚É£ Suppress False Positives (If Appropriate)\n"
          BODY="```go\n"
          BODY="// #nosec G304 - Justification for why this is safe\n"
          BODY="data, err := os.ReadFile(filePath)\n"
          BODY="```\n"
          BODY="### 4Ô∏è‚É£ Test Changes\n"
          BODY="```bash\n"
          BODY="# Run tests\n"
          BODY="go test ./...\n"
          BODY="# Run gosec locally\n"
          BODY="go install github.com/securego/gosec/v2/cmd/gosec@latest\n"
          BODY="gosec ./...\n"
          BODY="```\n"
          BODY="### 5Ô∏è‚É£ Verify Fix\n"
          BODY="- Push changes to a branch\n"
          BODY="- The gosec workflow will run automatically\n"
          BODY="- Verify it passes before merging\n"
          BODY="## üìö Resources\n"
          BODY="- [gosec Documentation](https://github.com/securego/gosec)\n"
          BODY="- [Available Rules](https://github.com/securego/gosec#available-rules)\n"
          BODY="- [CWE Database](https://cwe.mitre.org/)\n"
          BODY="- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-gosec.yml)\n"
          BODY="## üîî Next Steps\n"
          BODY="1. **Triage** issues by severity (HIGH ‚Üí MEDIUM ‚Üí LOW)\n"
          BODY="2. **Fix** legitimate security issues\n"
          BODY="3. **Suppress** false positives with `\#nosec` and justification\n"
          BODY="4. **Test** thoroughly to ensure no regressions\n"
          BODY="5. **Close** this issue once the workflow passes\n"
          BODY="---\n"
          BODY="*ü§ñ This issue was automatically created by the [gosec security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-gosec.yml)*"

          echo -e "$BODY" > issue_body.md
          gh issue create \
            --title "üö® [gosec] Security issues detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "gosec" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi

    - name: Fail if security issues found
      if: steps.gosec-scan.outcome == 'failure'
      run: exit 1