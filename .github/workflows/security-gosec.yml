name: Security - gosec

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2:30 AM UTC
    - cron: '30 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gosec:
    name: Go Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run gosec security scanner
      uses: securego/gosec@master
      with:
        args: '-fmt=json -out=gosec-results.json -stdout -verbose=text ./...'
      continue-on-error: true
      id: gosec-scan

    - name: Generate summary
      if: always()
      run: |
        echo "# gosec Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f gosec-results.json ]; then
          # Parse JSON results
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")

          if [ "$ISSUES" = "0" ]; then
            echo "## ‚úÖ No security issues found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Go source code passed all gosec security checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Security issues detected: $ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Rule | File | Line | Details |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY

            jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | \(.file) | \(.line) | \(.details) |"' gosec-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "1. Review each security issue listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Apply recommended fixes from gosec documentation" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run the scan to verify fixes" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No results file generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload gosec results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gosec-results
        path: gosec-results.json
        retention-days: 30

    - name: Create GitHub issue on security findings
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="gosec Security Scan"

        # Search for existing open issues with security label
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "gosec" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"

          # Count current issues
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")

          cat > comment_body.md << 'COMMENT_EOF'
## üîÑ Security Issues Still Present

**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Branch**: ${{ github.ref_name }}
**Commit**: ${{ github.sha }}
**Issues Count**: $ISSUES

### Latest Findings

<details>
<summary>Click to expand gosec findings</summary>

$(if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
  jq -r '.Issues[] | "**\(.severity)** - \(.rule_id) - `\(.file):\(.line)`\n\(.details)\n"' gosec-results.json 2>/dev/null | head -50
else
  echo "See workflow logs for details"
fi)

</details>

**Action Required**: Security issues persist. Please review and fix.
COMMENT_EOF

          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."

          # Parse issue details
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '[.Issues[] | select(.severity == "HIGH")] | length' gosec-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq -r '[.Issues[] | select(.severity == "MEDIUM")] | length' gosec-results.json 2>/dev/null || echo "0")
          LOW=$(jq -r '[.Issues[] | select(.severity == "LOW")] | length' gosec-results.json 2>/dev/null || echo "0")

          cat > issue_body.md << 'ISSUE_EOF'
# üö® Security Alert: Code Security Issues Detected (gosec)

## Overview

The **gosec** source code security scanner has detected security issues in the Go codebase.

| Field | Value |
|-------|-------|
| **Scanner** | gosec (Go AST security analyzer) |
| **Status** | ‚ùå FAILED |
| **Total Issues** | $ISSUES |
| **üî¥ HIGH** | $HIGH |
| **üü° MEDIUM** | $MEDIUM |
| **üü¢ LOW** | $LOW |
| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
| **Branch** | `${{ github.ref_name }}` |
| **Commit** | `${{ github.sha }}` |
| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

## üìã Security Issues Found

<details open>
<summary><b>Detailed Findings (Click to collapse)</b></summary>

$(if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
  echo "| Severity | Rule | File | Line | Details |"
  echo "|----------|------|------|------|---------|"
  jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | `\(.file)` | \(.line) | \(.details) |"' gosec-results.json 2>/dev/null
else
  echo "See workflow run logs for complete details"
fi)

</details>

## üîß Remediation Steps

### 1Ô∏è‚É£ Review Each Finding
- Examine the security issues listed above
- Understand the security risk for each
- Check gosec documentation for the specific rule ID

### 2Ô∏è‚É£ Fix Security Issues

Common fixes:
- **G104**: Add proper error handling
- **G304**: Validate file paths or add `#nosec` with justification
- **G401/G501**: Use stronger crypto algorithms
- **Others**: Follow gosec recommendations

### 3Ô∏è‚É£ Suppress False Positives (If Appropriate)
```go
// #nosec G304 - Justification for why this is safe
data, err := os.ReadFile(filePath)
```

### 4Ô∏è‚É£ Test Changes
```bash
# Run tests
go test ./...

# Run gosec locally
go install github.com/securego/gosec/v2/cmd/gosec@latest
gosec ./...
```

### 5Ô∏è‚É£ Verify Fix
- Push changes to a branch
- The gosec workflow will run automatically
- Verify it passes before merging

## üìö Resources

- [gosec Documentation](https://github.com/securego/gosec)
- [Available Rules](https://github.com/securego/gosec#available-rules)
- [CWE Database](https://cwe.mitre.org/)
- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-gosec.yml)

## üîî Next Steps

1. **Triage** issues by severity (HIGH ‚Üí MEDIUM ‚Üí LOW)
2. **Fix** legitimate security issues
3. **Suppress** false positives with `#nosec` and justification
4. **Test** thoroughly to ensure no regressions
5. **Close** this issue once the workflow passes

---

*ü§ñ This issue was automatically created by the [gosec security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-gosec.yml)*
ISSUE_EOF

          # Create issue with security labels
          gh issue create \
            --title "üö® [gosec] Security issues detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "gosec" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi

    - name: Fail if security issues found
      if: steps.gosec-scan.outcome == 'failure'
      run: exit 1
