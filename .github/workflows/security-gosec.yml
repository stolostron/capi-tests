name: Security Gosec

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2:30 AM UTC
    - cron: '30 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  gosec:
    name: Go Security Scanner
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Run gosec security scanner
      uses: securego/gosec@e2fa6ab0ba09771b9205dd0cafa997a2f730f582 # master
      with:
        args: '-fmt=json -out=gosec-results.json -stdout -verbose=text ./...'
      continue-on-error: true
      id: gosec-scan

    - name: Generate summary
      if: always()
      run: |
        echo "# gosec Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f gosec-results.json ]; then
          # Parse JSON results
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")

          if [ "$ISSUES" = "0" ]; then
            echo "## ‚úÖ No security issues found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Go source code passed all gosec security checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Security issues detected: $ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Rule | File | Line | Details |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY

            jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | \(.file) | \(.line) | \(.details) |"' gosec-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "1. Review each security issue listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Apply recommended fixes from gosec documentation" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run the scan to verify fixes" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No results file generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload gosec results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: gosec-results
        path: gosec-results.json
        retention-days: 30

    - name: Create GitHub issue on security findings
      if: steps.gosec-scan.outcome == 'failure' && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SERVER_URL: ${{ github.server_url }}
        REPO: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
        REF_NAME: ${{ github.ref_name }}
        SHA: ${{ github.sha }}
      run: |
        # Search for existing open issues with security labels (one issue per scanner type)
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "gosec" --json number --jq ".[0].number" 2>/dev/null || echo "")

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"

          # Count current issues
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")

          # Build comment body using echo statements to avoid YAML heredoc issues
          {
            echo "## üîÑ Security Issues Still Present"
            echo ""
            echo "**New Detection**: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}"
            echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "**Branch**: ${REF_NAME}"
            echo "**Commit**: ${SHA}"
            echo "**Issues Count**: $ISSUES"
            echo ""
            echo "### Latest Findings"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand gosec findings</summary>"
            echo ""
            if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
              jq -r '.Issues[] | "**\(.severity)** - \(.rule_id) - `\(.file):\(.line)`\n\(.details)\n"' gosec-results.json 2>/dev/null | head -50
            else
              echo "See workflow logs for details"
            fi
            echo ""
            echo "</details>"
            echo ""
            echo "**Action Required**: Security issues persist. Please review and fix."
          } > comment_body.md

          gh issue comment "$EXISTING_ISSUE" --body-file comment_body.md
        else
          echo "Creating new issue..."

          # Parse issue details
          ISSUES=$(jq -r '.Issues // [] | length' gosec-results.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '[.Issues[] | select(.severity == "HIGH")] | length' gosec-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq -r '[.Issues[] | select(.severity == "MEDIUM")] | length' gosec-results.json 2>/dev/null || echo "0")
          LOW=$(jq -r '[.Issues[] | select(.severity == "LOW")] | length' gosec-results.json 2>/dev/null || echo "0")

          # Build issue body using echo statements to avoid YAML heredoc issues
          {
            echo "# üö® Security Alert: Code Security Issues Detected (gosec)"
            echo ""
            echo "## Overview"
            echo ""
            echo "The **gosec** source code security scanner has detected security issues in the Go codebase."
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Scanner** | gosec (Go AST security analyzer) |"
            echo "| **Status** | ‚ùå FAILED |"
            echo "| **Total Issues** | $ISSUES |"
            echo "| **üî¥ HIGH** | $HIGH |"
            echo "| **üü° MEDIUM** | $MEDIUM |"
            echo "| **üü¢ LOW** | $LOW |"
            echo "| **Workflow Run** | [${RUN_ID}](${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}) |"
            echo "| **Branch** | \`${REF_NAME}\` |"
            echo "| **Commit** | \`${SHA}\` |"
            echo "| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |"
            echo ""
            echo "## üìã Security Issues Found"
            echo ""
            echo "<details open>"
            echo "<summary><b>Detailed Findings (Click to collapse)</b></summary>"
            echo ""
            if [ -f gosec-results.json ] && [ "$ISSUES" != "0" ]; then
              echo "| Severity | Rule | File | Line | Details |"
              echo "|----------|------|------|------|---------|"
              jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | `\(.file)` | \(.line) | \(.details) |"' gosec-results.json 2>/dev/null
            else
              echo "See workflow run logs for complete details"
            fi
            echo ""
            echo "</details>"
            echo ""
            echo "## üîß Remediation Steps"
            echo ""
            echo "### 1Ô∏è‚É£ Review Each Finding"
            echo "- Examine the security issues listed above"
            echo "- Understand the security risk for each"
            echo "- Check gosec documentation for the specific rule ID"
            echo ""
            echo "### 2Ô∏è‚É£ Fix Security Issues"
            echo ""
            echo "Common fixes:"
            echo "- **G104**: Add proper error handling"
            echo "- **G304**: Validate file paths or add \`#nosec\` with justification"
            echo "- **G401/G501**: Use stronger crypto algorithms"
            echo "- **Others**: Follow gosec recommendations"
            echo ""
            echo "### 3Ô∏è‚É£ Suppress False Positives (If Appropriate)"
            echo "\`\`\`go"
            echo "// #nosec G304 - Justification for why this is safe"
            echo "data, err := os.ReadFile(filePath)"
            echo "\`\`\`"
            echo ""
            echo "### 4Ô∏è‚É£ Test Changes"
            echo "\`\`\`bash"
            echo "# Run tests"
            echo "go test ./..."
            echo ""
            echo "# Run gosec locally"
            echo "go install github.com/securego/gosec/v2/cmd/gosec@latest"
            echo "gosec ./..."
            echo "\`\`\`"
            echo ""
            echo "### 5Ô∏è‚É£ Verify Fix"
            echo "- Push changes to a branch"
            echo "- The gosec workflow will run automatically"
            echo "- Verify it passes before merging"
            echo ""
            echo "## üìö Resources"
            echo ""
            echo "- [gosec Documentation](https://github.com/securego/gosec)"
            echo "- [Available Rules](https://github.com/securego/gosec#available-rules)"
            echo "- [CWE Database](https://cwe.mitre.org/)"
            echo "- [Workflow File](${SERVER_URL}/${REPO}/blob/main/.github/workflows/security-gosec.yml)"
            echo ""
            echo "## üîî Next Steps"
            echo ""
            echo "1. **Triage** issues by severity (HIGH ‚Üí MEDIUM ‚Üí LOW)"
            echo "2. **Fix** legitimate security issues"
            echo "3. **Suppress** false positives with \`#nosec\` and justification"
            echo "4. **Test** thoroughly to ensure no regressions"
            echo "5. **Close** this issue once the workflow passes"
            echo ""
            echo "---"
            echo ""
            echo "*ü§ñ This issue was automatically created by the [gosec security workflow](${SERVER_URL}/${REPO}/actions/workflows/security-gosec.yml)*"
          } > issue_body.md

          # Create issue with security labels
          gh issue create \
            --title "üö® [gosec] Security issues detected on ${REF_NAME}" \
            --label "security" \
            --label "gosec" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi

    - name: Fail if security issues found
      if: steps.gosec-scan.outcome == 'failure'
      run: exit 1
