name: Security - Trivy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  trivy:
    name: Trivy Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        exit-code: '1'
      continue-on-error: true
      id: trivy-scan

    - name: Run Trivy for human-readable output
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-results.txt'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      continue-on-error: true

    - name: Generate summary
      if: always()
      run: |
        echo "# Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Comprehensive security scan for vulnerabilities, misconfigurations, secrets, and dependencies." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f trivy-results.txt ]; then
          CRITICAL=$(grep -c "CRITICAL" trivy-results.txt 2>/dev/null || echo "0")
          HIGH=$(grep -c "HIGH" trivy-results.txt 2>/dev/null || echo "0")
          MEDIUM=$(grep -c "MEDIUM" trivy-results.txt 2>/dev/null || echo "0")
          LOW=$(grep -c "LOW" trivy-results.txt 2>/dev/null || echo "0")
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
          if [ "$TOTAL" = "0" ]; then
            echo "## ‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository passed all Trivy security checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Vulnerabilities detected: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No results file generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Trivy results (SARIF)
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy results (artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-results
        path: |
          trivy-results.sarif
          trivy-results.txt
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="Trivy Security Scan"
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "trivy" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")
        CRITICAL=$(grep -o "CRITICAL" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        HIGH=$(grep -o "HIGH" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        MEDIUM=$(grep -o "MEDIUM" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        LOW=$(grep -o "LOW" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"
          
          SCAN_DETAILS=$(cat trivy-results.txt 2>/dev/null | head -200 || echo "See workflow logs for full details")

          BODY="## üîÑ Vulnerabilities Still Present\n"
          BODY="${BODY}**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n"
          BODY="${BODY}**Date**: $(date -u +' %Y-%m-%d %H:%M:%S UTC')\n"
          BODY="${BODY}**Branch**: ${{ github.ref_name }}\n"
          BODY="${BODY}**Commit**: ${{ github.sha }}\n"
          BODY="${BODY}### Current Vulnerability Count\n"
          BODY="${BODY}| Severity | Count |\n"
          BODY="${BODY}|----------|-------|\n"
          BODY="${BODY}| üî¥ CRITICAL | $CRITICAL |\n"
          BODY="${BODY}| üü† HIGH | $HIGH |\n"
          BODY="${BODY}| üü° MEDIUM | $MEDIUM |\n"
          BODY="${BODY}| üü¢ LOW | $LOW |\n"
          BODY="${BODY}| **TOTAL** | **$TOTAL** |\n"
          BODY="${BODY}### Latest Scan Results\n"
          BODY="${BODY}<details>\n"
          BODY="${BODY}<summary>Click to expand Trivy scan output</summary>\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}$SCAN_DETAILS\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}</details>\n"
          BODY="${BODY}**Action Required**: Vulnerabilities persist. Please prioritize CRITICAL and HIGH severity issues.\n"
          BODY="${BODY}**Security Tab**: Check the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning) for detailed SARIF results."

          echo -e "$BODY" > comment_body.md
          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."
          
          SCAN_DETAILS=$(cat trivy-results.txt 2>/dev/null || echo "See workflow run logs for complete details")

          BODY="# üö® Security Alert: Multiple Vulnerabilities Detected (Trivy)\n"
          BODY="${BODY}## Overview\n"
          BODY="${BODY}The **Trivy** comprehensive security scanner has detected vulnerabilities, misconfigurations, or other security issues.\n"
          BODY="| Field | Value |\n"
          BODY="|-------|-------|\n"
          BODY="| **Scanner** | Trivy (Multi-purpose security scanner) |\n"
          BODY="| **Status** | ‚ùå FAILED |\n"
          BODY="| **üî¥ CRITICAL** | $CRITICAL |\n"
          BODY="| **üü† HIGH** | $HIGH |\n"
          BODY="| **üü° MEDIUM** | $MEDIUM |\n"
          BODY="| **üü¢ LOW** | $LOW |\n"
          BODY="| **TOTAL** | **$TOTAL** |\n"
          BODY="| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |\n"
          BODY="| **Branch** | \n"
          BODY="${BODY}${{ github.ref_name }}\n"
          BODY=" |\n"
          BODY="| **Commit** | \n"
          BODY="${BODY}${{ github.sha }}\n"
          BODY=" |\n"
          BODY="| **Date** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |\n"
          BODY="## üìä Severity Breakdown\n"
          BODY="```\n"
          BODY="${BODY}CRITICAL: $CRITICAL issues - ‚ö†Ô∏è  IMMEDIATE ACTION REQUIRED\n"
          BODY="${BODY}HIGH:     $HIGH issues    - üî• High priority, fix soon\n"
          BODY="${BODY}MEDIUM:   $MEDIUM issues  - ‚ö° Medium priority\n"
          BODY="LOW:      $LOW issues     - üìù Low priority\n"
          BODY="```\n"
          BODY="## üìã Detailed Scan Results\n"
          BODY="### View in GitHub Security Tab\n"
          BODY="üîí **SARIF Results**: [View in Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)\n"
          BODY="The SARIF output has been uploaded to GitHub's Security tab for detailed analysis.\n"
          BODY="### Scan Output\n"
          BODY="<details open>\n"
          BODY="<summary><b>Trivy Findings (Click to collapse)</b></summary>\n"
          BODY="```\n"
          BODY="$(cat trivy-results.txt 2>/dev/null || echo "See workflow run logs for complete details")\n"
          BODY="```\n"
          BODY="</details>\n"
          BODY="## üéØ What Trivy Scans\n"
          BODY="Trivy checks for:\n"
          BODY="- ‚úÖ **Vulnerabilities** in dependencies (Go modules, npm, etc.)\n"
          BODY="- ‚úÖ **Misconfigurations** in IaC files (Kubernetes, Docker, etc.)\n"
          BODY="- ‚úÖ **Secrets** accidentally committed to the repository\n"
          BODY="- ‚úÖ **License** compliance issues\n"
          BODY="- ‚úÖ **Container** image vulnerabilities (if applicable)\n"
          BODY="## üîß Remediation Steps\n"
          BODY="### 1Ô∏è‚É£ Prioritize by Severity\n"
          BODY="Focus on CRITICAL and HIGH severity issues first:\n"
          BODY="1. **CRITICAL**: Fix immediately (potential for severe impact)\n"
          BODY="2. **HIGH**: Fix within days (significant security risk)\n"
          BODY="3. **MEDIUM**: Fix within weeks (moderate risk)\n"
          BODY="4. **LOW**: Fix when convenient (low risk)\n"
          BODY="### 2Ô∏è‚É£ Update Vulnerable Dependencies\n"
          BODY="```bash\n"
          BODY="# For Go dependencies\ngo get -u <vulnerable-package>@<safe-version>\ngo mod tidy\n# Verify updates\ngo mod verify\n```\n"
          BODY="### 3Ô∏è‚É£ Fix Misconfigurations\n"
          BODY="Review and fix any configuration issues identified in:\n"
          BODY="- Kubernetes YAML files\n"
          BODY="- Docker configurations\n"
          BODY="- Infrastructure as Code files\n"
          BODY="### 4Ô∏è‚É£ Remove Secrets\n"
          BODY="If secrets were detected:\n"
          BODY="```bash\n"
          BODY="# Remove from current commit\ngit rm <file-with-secret>\n# Remove from history (DANGEROUS - coordinate with team)\ngit filter-branch --force --index-filter \"\n  'git rm --cached --ignore-unmatch <file-with-secret>' \"
  --prune-empty --tag-name-filter cat -- --all\n```\n"
          BODY="### 5Ô∏è‚É£ Test Changes\n"
          BODY="```bash\n"
          BODY="# Run tests\nmake test\n# Run Trivy locally\ndocker run --rm -v $(pwd):/scan aquasec/trivy fs /scan\n```\n"
          BODY="### 6Ô∏è‚É£ Verify Fix\n"
          BODY="- Push changes to a branch\n- Trivy workflow runs automatically\n- Check Security tab for SARIF results\n- Verify workflow passes\n"
          BODY="## üìö Resources\n"
          BODY="- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Trivy GitHub](https://github.com/aquasecurity/trivy)
- [Security Best Practices](https://aquasecurity.github.io/trivy/latest/docs/best-practices/)
- [GitHub Security Tab](${{ github.server_url }}/${{ github.repository }}/security)
- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-trivy.yml)
"
          BODY="## üîî Next Steps\n"
          BODY="1. **Review** the Security tab for detailed SARIF results\n"
          BODY="2. **Triage** by severity (CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW)\n"
          BODY="3. **Fix** vulnerabilities and misconfigurations\n"
          BODY="4. **Remove** any detected secrets\n"
          BODY="5. **Test** thoroughly\n"
          BODY="6. **Verify** the scan passes\n"
          BODY="7. **Close** this issue once resolved\n"
          BODY="---\n*ü§ñ This issue was automatically created by the [Trivy security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-trivy.yml)*"

          echo -e "$BODY" > issue_body.md
          gh issue create \
            --title "üö® [Trivy] $TOTAL vulnerabilities detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "trivy" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"

    - name: Fail if vulnerabilities found
      if: steps.trivy-scan.outcome == 'failure'
      run: exit 1