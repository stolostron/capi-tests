name: Security - Trivy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  trivy:
    name: Trivy Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        exit-code: '1'
      continue-on-error: true
      id: trivy-scan

    - name: Run Trivy for human-readable output
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-results.txt'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      continue-on-error: true

    - name: Generate summary
      if: always()
      run: |
        echo "# Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Comprehensive security scan for vulnerabilities, misconfigurations, secrets, and dependencies." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f trivy-results.txt ]; then
          # Count vulnerabilities by severity
          CRITICAL=$(grep -c "CRITICAL" trivy-results.txt 2>/dev/null || echo "0")
          HIGH=$(grep -c "HIGH" trivy-results.txt 2>/dev/null || echo "0")
          MEDIUM=$(grep -c "MEDIUM" trivy-results.txt 2>/dev/null || echo "0")
          LOW=$(grep -c "LOW" trivy-results.txt 2>/dev/null || echo "0")

          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

          if [ "$TOTAL" = "0" ]; then
            echo "## ‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository passed all Trivy security checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Vulnerabilities detected: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No results file generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Trivy results (SARIF)
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy results (artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-results
        path: |
          trivy-results.sarif
          trivy-results.txt
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="Trivy Security Scan"

        # Search for existing open issues with security label
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "trivy" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")

        # Count vulnerabilities by severity
        CRITICAL=$(grep -o "CRITICAL" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        HIGH=$(grep -o "HIGH" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        MEDIUM=$(grep -o "MEDIUM" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        LOW=$(grep -o "LOW" trivy-results.txt 2>/dev/null | wc -l || echo "0")
        TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"

          cat > comment_body.md << 'COMMENT_EOF'
## üîÑ Vulnerabilities Still Present

**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Branch**: ${{ github.ref_name }}
**Commit**: ${{ github.sha }}

### Current Vulnerability Count

| Severity | Count |
|----------|-------|
| üî¥ CRITICAL | $CRITICAL |
| üü† HIGH | $HIGH |
| üü° MEDIUM | $MEDIUM |
| üü¢ LOW | $LOW |
| **TOTAL** | **$TOTAL** |

### Latest Scan Results

<details>
<summary>Click to expand Trivy scan output</summary>

```
$(cat trivy-results.txt 2>/dev/null | head -200 || echo "See workflow logs for full details")
```

</details>

**Action Required**: Vulnerabilities persist. Please prioritize CRITICAL and HIGH severity issues.

**Security Tab**: Check the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning) for detailed SARIF results.
COMMENT_EOF

          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."

          cat > issue_body.md << 'ISSUE_EOF'
# üö® Security Alert: Multiple Vulnerabilities Detected (Trivy)

## Overview

The **Trivy** comprehensive security scanner has detected vulnerabilities, misconfigurations, or other security issues.

| Field | Value |
|-------|-------|
| **Scanner** | Trivy (Multi-purpose security scanner) |
| **Status** | ‚ùå FAILED |
| **üî¥ CRITICAL** | $CRITICAL |
| **üü† HIGH** | $HIGH |
| **üü° MEDIUM** | $MEDIUM |
| **üü¢ LOW** | $LOW |
| **TOTAL** | **$TOTAL** |
| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
| **Branch** | `${{ github.ref_name }}` |
| **Commit** | `${{ github.sha }}` |
| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

## üìä Severity Breakdown

```
CRITICAL: $CRITICAL issues - ‚ö†Ô∏è  IMMEDIATE ACTION REQUIRED
HIGH:     $HIGH issues    - üî• High priority, fix soon
MEDIUM:   $MEDIUM issues  - ‚ö° Medium priority
LOW:      $LOW issues     - üìù Low priority
```

## üìã Detailed Scan Results

### View in GitHub Security Tab

üîí **SARIF Results**: [View in Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)

The SARIF output has been uploaded to GitHub's Security tab for detailed analysis.

### Scan Output

<details open>
<summary><b>Trivy Findings (Click to collapse)</b></summary>

```
$(cat trivy-results.txt 2>/dev/null || echo "See workflow run logs for complete details")
```

</details>

## üéØ What Trivy Scans

Trivy checks for:
- ‚úÖ **Vulnerabilities** in dependencies (Go modules, npm, etc.)
- ‚úÖ **Misconfigurations** in IaC files (Kubernetes, Docker, etc.)
- ‚úÖ **Secrets** accidentally committed to the repository
- ‚úÖ **License** compliance issues
- ‚úÖ **Container** image vulnerabilities (if applicable)

## üîß Remediation Steps

### 1Ô∏è‚É£ Prioritize by Severity

Focus on CRITICAL and HIGH severity issues first:
1. **CRITICAL**: Fix immediately (potential for severe impact)
2. **HIGH**: Fix within days (significant security risk)
3. **MEDIUM**: Fix within weeks (moderate risk)
4. **LOW**: Fix when convenient (low risk)

### 2Ô∏è‚É£ Update Vulnerable Dependencies

```bash
# For Go dependencies
go get -u <vulnerable-package>@<safe-version>
go mod tidy

# Verify updates
go mod verify
```

### 3Ô∏è‚É£ Fix Misconfigurations

Review and fix any configuration issues identified in:
- Kubernetes YAML files
- Docker configurations
- Infrastructure as Code files

### 4Ô∏è‚É£ Remove Secrets

If secrets were detected:
```bash
# Remove from current commit
git rm <file-with-secret>

# Remove from history (DANGEROUS - coordinate with team)
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch <file-with-secret>' \
  --prune-empty --tag-name-filter cat -- --all
```

### 5Ô∏è‚É£ Test Changes

```bash
# Run tests
make test

# Run Trivy locally
docker run --rm -v $(pwd):/scan aquasec/trivy fs /scan
```

### 6Ô∏è‚É£ Verify Fix

- Push changes to a branch
- Trivy workflow runs automatically
- Check Security tab for SARIF results
- Verify workflow passes

## üìö Resources

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Trivy GitHub](https://github.com/aquasecurity/trivy)
- [Security Best Practices](https://aquasecurity.github.io/trivy/latest/docs/best-practices/)
- [GitHub Security Tab](${{ github.server_url }}/${{ github.repository }}/security)
- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-trivy.yml)

## üîî Next Steps

1. **Review** the Security tab for detailed SARIF results
2. **Triage** by severity (CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW)
3. **Fix** vulnerabilities and misconfigurations
4. **Remove** any detected secrets
5. **Test** thoroughly
6. **Verify** the scan passes
7. **Close** this issue once resolved

---

*ü§ñ This issue was automatically created by the [Trivy security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-trivy.yml)*
ISSUE_EOF

          # Create issue with security labels
          gh issue create \
            --title "üö® [Trivy] $TOTAL vulnerabilities detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "trivy" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi

    - name: Fail if vulnerabilities found
      if: steps.trivy-scan.outcome == 'failure'
      run: exit 1
