# Continuous Integration workflow
# Runs lint and tests on all pull requests and pushes
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84 # v6
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Install OpenShift CLI
        run: |
          wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client

      - name: Verify Azure CLI (already installed)
        run: az version

      - name: Run check dependencies tests
        run: |
          mkdir -p test-results
          go run gotest.tools/gotestsum@v1.13.0 \
            --format testname \
            --jsonfile test-results/tests.json \
            --junitfile test-results/junit.xml \
            -- -short -v ./test -run TestCheckDependencies
        id: test-run

      - name: Generate test summary
        if: always()
        run: |
          echo "# CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results/tests.json ]; then
            echo "| Test | Status | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY

            jq -r 'select(.Test != null and .Action != null) |
                   select(.Action == "pass" or .Action == "fail" or .Action == "skip") |
                   "| \(.Test) | \(if .Action == "pass" then "PASS" elif .Action == "fail" then "FAIL" else "SKIP" end) | \(.Elapsed // 0)s |"' \
                   test-results/tests.json >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            PASSED=$(jq -r 'select(.Action == "pass")' test-results/tests.json | wc -l)
            FAILED=$(jq -r 'select(.Action == "fail")' test-results/tests.json | wc -l)
            SKIPPED=$(jq -r 'select(.Action == "skip")' test-results/tests.json | wc -l)

            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- **Skipped:** $SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create test annotations
        if: always()
        run: |
          if [ -f test-results/tests.json ]; then
            jq -r 'select(.Test != null and .Action == "fail") |
                   "::error file=test/01_check_dependencies_test.go,title=Test Failed::\(.Test) failed"' \
                   test-results/tests.json || true
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-results
          path: test-results/
          retention-days: 30
