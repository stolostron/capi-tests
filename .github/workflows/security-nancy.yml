name: Security - nancy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3:30 AM UTC
    - cron: '30 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  nancy:
    name: Nancy Dependency Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Install dependencies
      run: go mod download

    - name: Write Go Dependencies List
      run: go list -json -deps ./... > go.list

    - name: Run nancy dependency scanner
      uses: sonatype-nexus-community/nancy-github-action@main
      with:
        nancyCommand: sleuth --loud
      continue-on-error: true
      id: nancy-scan

    - name: Generate summary
      if: always()
      run: |
        echo "# nancy Dependency Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scanning Go dependencies for known vulnerabilities using Sonatype OSS Index." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check nancy scan result
        if [ "${{ steps.nancy-scan.outcome }}" = "success" ]; then
          echo "## âœ… No vulnerable dependencies found!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Go dependencies passed nancy security checks." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Vulnerable dependencies detected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Nancy found one or more dependencies with known vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remediation Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the vulnerabilities in the workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Update affected dependencies: \`go get -u <package>\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`go mod tidy\` to clean up" >> $GITHUB_STEP_SUMMARY
          echo "4. Test thoroughly after updates" >> $GITHUB_STEP_SUMMARY
          echo "5. Re-run this workflow to verify fixes" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload dependency list
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nancy-dependency-list
        path: go.list
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="nancy Dependency Scan"

        # Search for existing open issues with security label
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "nancy" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"

          cat > comment_body.md << 'COMMENT_EOF'
## ðŸ”„ Vulnerable Dependencies Still Present

**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Branch**: ${{ github.ref_name }}
**Commit**: ${{ github.sha }}

### Status

Nancy continues to detect vulnerable Go dependencies from the Sonatype OSS Index.

<details>
<summary>View workflow logs for details</summary>

Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for specific vulnerable packages and versions.

</details>

**Action Required**: Update vulnerable dependencies to patched versions.
COMMENT_EOF

          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."

          cat > issue_body.md << 'ISSUE_EOF'
# ðŸš¨ Security Alert: Vulnerable Go Dependencies (nancy)

## Overview

The **nancy** dependency scanner has detected Go dependencies with known vulnerabilities from the **Sonatype OSS Index**.

| Field | Value |
|-------|-------|
| **Scanner** | nancy (Sonatype OSS Index) |
| **Status** | âŒ FAILED |
| **Database** | Sonatype OSS Index |
| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
| **Branch** | `${{ github.ref_name }}` |
| **Commit** | `${{ github.sha }}` |
| **Triggered By** | ${{ github.event_name }} |
| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

## ðŸ“‹ Vulnerability Details

Nancy scans your Go dependencies (`go.list`) against the Sonatype OSS Index for known security vulnerabilities.

### View Full Results

Check the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for:
- Specific vulnerable package names
- CVE identifiers
- Vulnerability severity ratings
- Recommended patch versions

### Dependency List

The scan analyzed dependencies from `go.list`. Download the artifact from the workflow run to see the full dependency tree.

## ðŸ”§ Remediation Steps

### 1ï¸âƒ£ Identify Vulnerable Packages

Review the workflow logs to identify which packages have vulnerabilities:
```
Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
```

### 2ï¸âƒ£ Update Dependencies

For each vulnerable package:

```bash
# Update specific package to patched version
go get -u <vulnerable-package>@<safe-version>

# Example:
# go get -u github.com/example/pkg@v1.2.3

# Update go.mod and go.sum
go mod tidy

# Verify no broken dependencies
go mod verify
```

### 3ï¸âƒ£ Check for Breaking Changes

```bash
# Run all tests
go test ./...

# Or use make
make test
```

### 4ï¸âƒ£ Run nancy Locally (Optional)

```bash
# Install nancy
go install github.com/sonatype-nexus-community/nancy@latest

# Generate dependency list
go list -json -deps ./... > go.list

# Run nancy scan
nancy sleuth --loud < go.list
```

### 5ï¸âƒ£ Verify Fix

- Push your changes to a branch
- The nancy workflow will run automatically
- Verify it passes before merging
- Check that no new vulnerabilities were introduced

## ðŸ’¡ Best Practices

### Keep Dependencies Updated

```bash
# Check for outdated dependencies
go list -u -m all

# Update all dependencies (careful - test thoroughly)
go get -u ./...
go mod tidy
```

### Use Dependabot

Consider enabling GitHub Dependabot for automatic dependency updates:
1. Go to repository **Settings** â†’ **Security & analysis**
2. Enable **Dependabot security updates**
3. Enable **Dependabot version updates**

### Regular Scans

- Nancy runs daily at 3:30 AM UTC
- Also runs on all PRs and pushes
- Monitor Security tab regularly

## ðŸ“š Resources

- [nancy Documentation](https://github.com/sonatype-nexus-community/nancy)
- [Sonatype OSS Index](https://ossindex.sonatype.org/)
- [Go Vulnerability Database](https://vuln.go.dev/)
- [Go Module Documentation](https://go.dev/ref/mod)
- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-nancy.yml)

## ðŸ”„ Comparison with govulncheck

This repository uses both **nancy** and **govulncheck**:

| Scanner | Database | Focus |
|---------|----------|-------|
| **nancy** | Sonatype OSS Index | Broader vulnerability database |
| **govulncheck** | Go Vulnerability DB | Official Go vulnerabilities |

Both scanners complement each other - fix vulnerabilities found by either scanner.

## ðŸ”” Next Steps

1. **Review** workflow logs for vulnerable package details
2. **Update** each vulnerable dependency to a safe version
3. **Test** thoroughly to ensure no breaking changes
4. **Verify** nancy scan passes
5. **Close** this issue once resolved

---

*ðŸ¤– This issue was automatically created by the [nancy security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-nancy.yml)*
ISSUE_EOF

          # Create issue with security labels
          gh issue create \
            --title "ðŸš¨ [nancy] Vulnerable dependencies detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "nancy" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi

    - name: Fail if vulnerabilities found
      if: steps.nancy-scan.outcome == 'failure'
      run: exit 1
