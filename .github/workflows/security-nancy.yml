name: Security - nancy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3:30 AM UTC
    - cron: '30 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  nancy:
    name: Nancy Dependency Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Install dependencies
      run: go mod download

    - name: Write Go Dependencies List
      run: go list -json -deps ./... > go.list

    - name: Run nancy dependency scanner
      uses: sonatype-nexus-community/nancy-github-action@main
      with:
        nancyCommand: sleuth --loud
      continue-on-error: true
      id: nancy-scan

    - name: Generate summary
      if: always()
      run: |
        echo "# nancy Dependency Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scanning Go dependencies for known vulnerabilities using Sonatype OSS Index." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.nancy-scan.outcome }}" = "success" ]; then
          echo "## âœ… No vulnerable dependencies found!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Go dependencies passed nancy security checks." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Vulnerable dependencies detected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Nancy found one or more dependencies with known vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remediation Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the vulnerabilities in the workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Update affected dependencies: \`go get -u <package>\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`go mod tidy\` to clean up" >> $GITHUB_STEP_SUMMARY
          echo "4. Test thoroughly after updates" >> $GITHUB_STEP_SUMMARY
          echo "5. Re-run this workflow to verify fixes" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload dependency list
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nancy-dependency-list
        path: go.list
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="nancy Dependency Scan"
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "nancy" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")
        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"
          
          BODY="## ðŸ”„ Vulnerable Dependencies Still Present\n"
          BODY="${BODY}**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n"
          BODY="${BODY}**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n"
          BODY="${BODY}**Branch**: ${{ github.ref_name }}\n"
          BODY="${BODY}**Commit**: ${{ github.sha }}\n"
          BODY="${BODY}### Status\n"
          BODY="${BODY}Nancy continues to detect vulnerable Go dependencies from the Sonatype OSS Index.\n"
          BODY="${BODY}<details>\n"
          BODY="${BODY}<summary>View workflow logs for details</summary>\n"
          BODY="${BODY}Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for specific vulnerable packages and versions.\n"
          BODY="${BODY}</details>\n"
          BODY="${BODY}**Action Required**: Update vulnerable dependencies to patched versions."

          echo -e "$BODY" > comment_body.md
          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."
          
          BODY="# ðŸš¨ Security Alert: Vulnerable Go Dependencies (nancy)\n"
          # ... (rest of body)

          echo -e "$BODY" > issue_body.md
          gh issue create \
            --title "ðŸš¨ [nancy] Vulnerable dependencies detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "nancy" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi