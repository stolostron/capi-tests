# Full Test Suite workflow
# Runs all test phases - triggered manually or on schedule
name: Full Test Suite

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      skip_azure_tests:
        description: 'Skip Azure-dependent tests'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  issues: write

env:
  ARO_REPO_URL: https://github.com/RadekCap/cluster-api-installer.git
  ARO_REPO_BRANCH: ARO-ASO
  ARO_REPO_DIR: /tmp/cluster-api-installer-aro

jobs:
  check-dependencies:
    name: Phase 1 - Check Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Install OpenShift CLI
        run: |
          wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client

      - name: Verify Azure CLI
        run: az version

      - name: Run check dependencies tests
        run: |
          mkdir -p test-results
          go run gotest.tools/gotestsum@v1.13.0 \
            --format testname \
            --jsonfile test-results/tests.json \
            --junitfile test-results/junit.xml \
            -- -v ./test -run TestCheckDependencies

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-results-check-dependencies
          path: test-results/
          retention-days: 30

  setup:
    name: Phase 2 - Repository Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-dependencies

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run setup tests
        run: |
          mkdir -p test-results
          go run gotest.tools/gotestsum@v1.13.0 \
            --format testname \
            --jsonfile test-results/tests.json \
            --junitfile test-results/junit.xml \
            -- -v ./test -run TestSetup -timeout 10m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-results-setup
          path: test-results/
          retention-days: 30

  kind-cluster:
    name: Phase 3 - Kind Cluster
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Install Helm
        uses: azure/setup-helm@bf6a7d304bc2fdb57e0331155b7ebf2c504acf0a # v4
        with:
          version: 'v3.16.0'

      - name: Clone cluster-api-installer repository
        run: |
          if [ -d "$ARO_REPO_DIR" ]; then
            echo "Repository already exists, skipping clone"
          else
            git clone -b "$ARO_REPO_BRANCH" "$ARO_REPO_URL" "$ARO_REPO_DIR"
            echo "Repository cloned successfully"
          fi

      - name: Run Kind cluster tests
        run: |
          mkdir -p test-results
          go run gotest.tools/gotestsum@v1.13.0 \
            --format testname \
            --jsonfile test-results/tests.json \
            --junitfile test-results/junit.xml \
            -- -v ./test -run TestKindCluster -timeout 30m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-results-kind-cluster
          path: test-results/
          retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [check-dependencies, setup, kind-cluster]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          path: all-results

      - name: Generate summary
        env:
          NEEDS_RESULTS: ${{ toJSON(needs) }}
        run: |
          echo "# Full Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          PHASES=("check-dependencies" "setup" "kind-cluster")

          for phase in "${PHASES[@]}"; do
            status=$(echo "$NEEDS_RESULTS" | jq -r ".\"$phase\".result // \"skipped\"")
            case "$status" in
              success) echo "| $phase | PASS |" >> $GITHUB_STEP_SUMMARY ;;
              failure) echo "| $phase | FAIL |" >> $GITHUB_STEP_SUMMARY ;;
              skipped) echo "| $phase | SKIP |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| $phase | $status |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test results are available as artifacts for each phase." >> $GITHUB_STEP_SUMMARY
