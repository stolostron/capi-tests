name: Security Govulncheck

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Run govulncheck
      run: |
        echo "# govulncheck Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scanning Go code and dependencies for known vulnerabilities..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Run govulncheck and capture output
        if govulncheck ./... 2>&1 | tee govulncheck-output.txt; then
          echo "## ‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Go dependencies are free from known vulnerabilities." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ùå Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat govulncheck-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: govulncheck-results
        path: govulncheck-output.txt
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SERVER_URL: ${{ github.server_url }}
        REPO: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
        REF_NAME: ${{ github.ref_name }}
        SHA: ${{ github.sha }}
        EVENT_NAME: ${{ github.event_name }}
      run: |
        # Search for existing open issues with security labels (one issue per scanner type)
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "govulncheck" --json number --jq ".[0].number" 2>/dev/null || echo "")

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"

          # Build comment body using echo statements to avoid YAML heredoc issues
          {
            echo "## üîÑ Vulnerability Still Present"
            echo ""
            echo "**New Detection**: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}"
            echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "**Branch**: ${REF_NAME}"
            echo "**Commit**: ${SHA}"
            echo ""
            echo "### Latest Scan Output"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand scan results</summary>"
            echo ""
            echo "\`\`\`"
            cat govulncheck-output.txt 2>/dev/null | head -100 || echo "See workflow logs for full details"
            echo "\`\`\`"
            echo ""
            echo "</details>"
            echo ""
            echo "**Action Required**: The vulnerabilities listed in this issue are still present. Please prioritize remediation."
          } > comment_body.md

          gh issue comment "$EXISTING_ISSUE" --body-file comment_body.md
        else
          echo "Creating new issue..."

          # Count vulnerabilities if possible
          VULN_COUNT=$(grep -c "Vulnerability" govulncheck-output.txt 2>/dev/null || echo "unknown")

          # Build issue body using echo statements to avoid YAML heredoc issues
          {
            echo "# üö® Security Alert: Go Vulnerabilities Detected"
            echo ""
            echo "## Overview"
            echo ""
            echo "The **govulncheck** security scanner has detected vulnerabilities in Go dependencies."
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Scanner** | govulncheck (Official Go vulnerability checker) |"
            echo "| **Status** | ‚ùå FAILED |"
            echo "| **Vulnerabilities** | $VULN_COUNT |"
            echo "| **Workflow Run** | [${RUN_ID}](${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}) |"
            echo "| **Branch** | \`${REF_NAME}\` |"
            echo "| **Commit** | \`${SHA}\` |"
            echo "| **Triggered By** | ${EVENT_NAME} |"
            echo "| **Date** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |"
            echo ""
            echo "## üìã Vulnerability Details"
            echo ""
            echo "<details open>"
            echo "<summary><b>Scan Results (Click to collapse)</b></summary>"
            echo ""
            echo "\`\`\`"
            cat govulncheck-output.txt 2>/dev/null || echo "See workflow run logs for complete details"
            echo "\`\`\`"
            echo ""
            echo "</details>"
            echo ""
            echo "## üîß Remediation Steps"
            echo ""
            echo "### 1Ô∏è‚É£ Review Vulnerabilities"
            echo "- Examine the scan output above"
            echo "- Check severity levels and affected packages"
            echo "- Review [Go Vulnerability Database](https://vuln.go.dev/) for details"
            echo ""
            echo "### 2Ô∏è‚É£ Update Dependencies"
            echo "\`\`\`bash"
            echo "# Update specific vulnerable package"
            echo "go get -u <vulnerable-package>@<patched-version>"
            echo ""
            echo "# Or update all dependencies (careful - test thoroughly)"
            echo "go get -u ./..."
            echo "go mod tidy"
            echo "\`\`\`"
            echo ""
            echo "### 3Ô∏è‚É£ Test Changes"
            echo "\`\`\`bash"
            echo "# Run tests"
            echo "make test"
            echo ""
            echo "# Run all security scans"
            echo "make test-all"
            echo "\`\`\`"
            echo ""
            echo "### 4Ô∏è‚É£ Verify Fix"
            echo "- Push changes to a branch"
            echo "- The govulncheck workflow will run automatically"
            echo "- Verify it passes before merging"
            echo ""
            echo "## üìö Resources"
            echo ""
            echo "- [Go Vulnerability Database](https://vuln.go.dev/)"
            echo "- [govulncheck Documentation](https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck)"
            echo "- [Workflow File](${SERVER_URL}/${REPO}/blob/main/.github/workflows/security-govulncheck.yml)"
            echo ""
            echo "## üîî Next Steps"
            echo ""
            echo "1. **Assign** this issue to a developer"
            echo "2. **Prioritize** based on vulnerability severity"
            echo "3. **Update** dependencies as outlined above"
            echo "4. **Test** thoroughly to ensure no regressions"
            echo "5. **Close** this issue once the workflow passes"
            echo ""
            echo "---"
            echo ""
            echo "*ü§ñ This issue was automatically created by the [govulncheck security workflow](${SERVER_URL}/${REPO}/actions/workflows/security-govulncheck.yml)*"
          } > issue_body.md

          # Create issue with security labels
          gh issue create \
            --title "üö® [govulncheck] Vulnerabilities detected on ${REF_NAME}" \
            --label "security" \
            --label "govulncheck" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi
