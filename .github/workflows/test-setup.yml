name: Repository Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  test-setup:
    name: Repository Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: go mod download

    - name: Run setup tests
      run: |
        mkdir -p test-results
        go run gotest.tools/gotestsum@v1.13.0 --format testname --jsonfile test-results/tests.json --junitfile test-results/junit.xml -- -v ./test -run TestSetup -timeout 10m
      continue-on-error: true
      id: test-run

    - name: Generate test summary
      if: always()
      run: |
        cat > summary.sh << 'SCRIPT'
        #!/bin/bash

        echo "# Test Repository Setup Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f test-results/tests.json ]; then
          # Parse JSON and create summary table
          echo "| Test | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Process each test event
          jq -r 'select(.Test != null and .Action != null) |
                 select(.Action == "pass" or .Action == "fail" or .Action == "skip") |
                 "| \(.Test) | \(if .Action == "pass" then "✅ PASS" elif .Action == "fail" then "❌ FAIL" else "⏭️ SKIP" end) | \(.Elapsed // 0)s |"' \
                 test-results/tests.json >> $GITHUB_STEP_SUMMARY

          # Add overall summary
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq -r 'select(.Test != null and .Action != null) | select(.Action == "pass" or .Action == "fail" or .Action == "skip")' test-results/tests.json | wc -l)
          PASSED=$(jq -r 'select(.Action == "pass")' test-results/tests.json | wc -l)
          FAILED=$(jq -r 'select(.Action == "fail")' test-results/tests.json | wc -l)
          SKIPPED=$(jq -r 'select(.Action == "skip")' test-results/tests.json | wc -l)

          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ✅ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ❌ $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped:** ⏭️ $SKIPPED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        SCRIPT

        chmod +x summary.sh
        ./summary.sh

    - name: Create test annotations
      if: always()
      run: |
        if [ -f test-results/tests.json ]; then
          jq -r 'select(.Test != null and .Action == "fail") |
                 "::error file=test/02_setup_test.go,title=Test Failed::\(.Test) failed"' \
                 test-results/tests.json || true
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: test-results-setup
        path: test-results/
        retention-days: 30

    - name: Create GitHub issue on failure
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Check if there's already an open issue for this workflow
        WORKFLOW_NAME="Test Repository Setup"
        EXISTING_ISSUE=$(gh issue list --label "automated" --label "test-failure" --state open --json number,title --jq ".[] | select(.title | contains(\"[$WORKFLOW_NAME]\")) | .number | select(. != null)" | head -1)

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Issue already exists: #$EXISTING_ISSUE"
          gh issue comment $EXISTING_ISSUE --body "Workflow failed again in run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        else
          # Extract failed tests from JSON
          FAILED_TESTS=""
          if [ -f test-results/tests.json ]; then
            FAILED_TESTS=$(jq -r 'select(.Test != null and .Action == "fail") | .Test' test-results/tests.json | head -5)
          fi

          # Create issue body
          cat > issue_body.md << EOF
        ## Test Repository Setup Workflow Failed

        **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        **Triggered by:** ${{ github.event_name }}

        ### Failed Tests
        EOF

          if [ -n "$FAILED_TESTS" ]; then
            echo '```' >> issue_body.md
            echo "$FAILED_TESTS" >> issue_body.md
            echo '```' >> issue_body.md
          else
            echo "No test results available" >> issue_body.md
          fi

          echo "" >> issue_body.md
          echo "---" >> issue_body.md
          echo "*This issue was automatically created by the CI workflow*" >> issue_body.md

          # Create the issue
          gh issue create \
            --title "[$WORKFLOW_NAME] Workflow failed on ${{ github.ref_name }}" \
            --body-file issue_body.md \
            --label "automated" \
            --label "test-failure"
        fi

    - name: Fail if tests failed
      if: steps.test-run.outcome == 'failure'
      run: exit 1
